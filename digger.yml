projects:
- name: production
  dir: prod
  workflow: with-infracost

workflows:
  with-infracost:
    plan:
      steps:
        - init
        - plan
        - run: git checkout $DEFAULT_BRANCH && infracost breakdown --path . --format=json --out-file=$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json && git checkout $PR_BRANCH
        - run: infracost diff --path=. \
                          --format=json \
                          --compare-to=$RUNNER_TEMP/infracost-base-${PROJECT_NAME}.json \
                          --out-file=$DIGGER_OUT
